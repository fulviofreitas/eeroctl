# ============================================================================
# ðŸ”„ Renovate - Automated Dependency Updates
# ============================================================================
# Runs Renovate to check for dependency updates and create PRs.
# Uses the reusable renovate action from eero-api.
#
# Key features:
# - Tracks eero-api dependency via repository_dispatch
# - Auto-merges minor/patch updates for most dependencies
# - Requires manual review for major updates
# - Repository caching for faster subsequent runs
#
# Triggers:
# - Scheduled: Every 6 hours (4 times daily)
# - Manual: workflow_dispatch
# - On eero-api release: repository_dispatch
# ============================================================================

name: ðŸ”„ Renovate

on:
  schedule:
    # Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: "0 */6 * * *"

  workflow_dispatch:
    inputs:
      dry_run:
        description: "ðŸ§ª Dry-run mode (no PRs created)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      log_level:
        description: "ðŸ“ Log level"
        required: false
        default: "info"
        type: choice
        options:
          - "debug"
          - "info"
          - "warn"
      reset_cache:
        description: "ðŸ—‘ï¸ Reset repository cache"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

  repository_dispatch:
    types: [eero-api-dependency-update-available]

# Prevent concurrent runs
concurrency:
  group: renovate
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # ============================================================================
  # ðŸ”„ Run Renovate
  # ============================================================================
  renovate:
    name: ðŸ”„ Renovate
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ“‹ Log trigger info
        run: |
          echo "ðŸŽ¯ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ðŸ”— Source: ${{ github.event.client_payload.repository }}"
            echo "ðŸ“¦ Package: ${{ github.event.client_payload.package || 'eero-api' }}"
            echo "ðŸ·ï¸ Version: ${{ github.event.client_payload.version }}"
            echo "ðŸ”– Tag: ${{ github.event.client_payload.tag }}"
            echo "ðŸ‘¤ Triggered by: ${{ github.event.client_payload.triggered_by || 'unknown' }}"
          fi

      # ========================================================================
      # â³ Wait for PyPI Indexing
      # ========================================================================
      # PyPI indexing typically takes 1-5 minutes after package upload.
      # This step polls PyPI until the new version is available.
      - name: â³ Wait for PyPI indexing
        if: github.event_name == 'repository_dispatch'
        uses: fulviofreitas/eero-api/.github/actions/wait-for-pypi@master
        with:
          package: ${{ github.event.client_payload.package || 'eero-api' }}
          version: ${{ github.event.client_payload.version }}

      # ========================================================================
      # ðŸ”„ Run Renovate
      # ========================================================================
      - name: ðŸ”„ Run Renovate
        uses: fulviofreitas/eero-api/.github/actions/renovate@master
        with:
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          app-private-key: ${{ secrets.RENOVATE_APP_PRIVATE_KEY }}
          config-file: ".github/renovate.json5"
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}
          log-level: ${{ github.event.inputs.log_level || 'info' }}
          reset-cache: ${{ github.event.inputs.reset_cache || 'false' }}

      # ========================================================================
      # ðŸ“ Summary
      # ========================================================================
      - name: ðŸ“ Generate summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”„ Renovate Summary

          | Property | Value |
          |:---------|:------|
          | ðŸ“¦ Repository | [\`${{ github.repository }}\`](https://github.com/${{ github.repository }}) |
          | ðŸŽ¯ Trigger | \`${{ github.event_name }}\` |
          | ðŸ§ª Dry Run | \`${{ github.event.inputs.dry_run || 'false' }}\` |

          EOF

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF

          ### ðŸ“¦ Triggered by Dependency Release

          | Property | Value |
          |:---------|:------|
          | ðŸ”— Source | [\`${{ github.event.client_payload.repository || 'unknown' }}\`](https://github.com/${{ github.event.client_payload.repository }}) |
          | ðŸ“¦ Package | \`${{ github.event.client_payload.package || 'eero-api' }}\` |
          | ðŸ·ï¸ Version | \`${{ github.event.client_payload.version || 'unknown' }}\` |
          | ðŸ”– Tag | \`${{ github.event.client_payload.tag || 'unknown' }}\` |
          | ðŸ‘¤ Triggered by | \`${{ github.event.client_payload.triggered_by || 'unknown' }}\` |

          EOF
          fi
