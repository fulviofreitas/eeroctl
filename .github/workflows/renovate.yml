# ============================================================================
# ğŸ”„ Renovate - Automated Dependency Updates
# ============================================================================
# Runs Renovate to check for dependency updates and create PRs.
# Uses the centralized renovate action from eero-api.
#
# Key features:
# - Tracks eero-api git dependency via custom regex manager
# - Auto-merges minor/patch updates for most dependencies
# - Requires manual review for eero-api and major updates
# - Repository caching for faster subsequent runs
#
# Triggers:
# - Scheduled: Every 6 hours (4 times daily)
# - Manual: workflow_dispatch
# - On eero-api release: repository_dispatch
# ============================================================================

name: ğŸ”„ Renovate

on:
  schedule:
    # Weekly on Mondays at 3 AM UTC
    - cron: "0 */6 * * *"

  workflow_dispatch:
    inputs:
      dry_run:
        description: "ğŸ§ª Dry-run mode (no PRs created)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      log_level:
        description: "ğŸ“ Log level"
        required: false
        default: "info"
        type: choice
        options:
          - "debug"
          - "info"
          - "warn"
      reset_cache:
        description: "ğŸ—‘ï¸ Reset repository cache"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

  # Triggered by eero-api releases
  repository_dispatch:
    types: [eero-api-dependency-update-available]

# Prevent concurrent runs
concurrency:
  group: renovate
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # ============================================================================
  # ğŸ”„ Run Renovate
  # ============================================================================
  renovate:
    name: ğŸ”„ Renovate
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ“‹ Log trigger info
        run: |
          echo "ğŸ¯ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸ“¦ eero-api version: ${{ github.event.client_payload.version }}"
            echo "ğŸ”– eero-api tag: ${{ github.event.client_payload.tag }}"
          fi

      - name: ğŸ”„ Run Renovate
        uses: fulviofreitas/eero-api/.github/actions/renovate@master
        with:
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          app-private-key: ${{ secrets.RENOVATE_APP_PRIVATE_KEY }}
          config-file: .github/renovate.json5
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}
          log-level: ${{ github.event.inputs.log_level || 'info' }}
          reset-cache: ${{ github.event.inputs.reset_cache || 'false' }}
