# ============================================================================
# üîÑ Renovate - Automated Dependency Updates
# ============================================================================
# Runs Renovate to check for dependency updates and create PRs.
# Uses the centralized renovate action from eero-api.
#
# Key features:
# - Tracks eero-api git dependency via custom regex manager
# - Auto-merges minor/patch updates for most dependencies
# - Requires manual review for eero-api and major updates
# - Repository caching for faster subsequent runs
#
# Triggers:
# - Scheduled: Every 6 hours (4 times daily)
# - Manual: workflow_dispatch
# - On eero-api release: repository_dispatch
# ============================================================================

name: üîÑ Renovate

on:
  schedule:
    # Weekly on Mondays at 3 AM UTC
    - cron: "0 */6 * * *"

  workflow_dispatch:
    inputs:
      dry_run:
        description: "üß™ Dry-run mode (no PRs created)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      log_level:
        description: "üìù Log level"
        required: false
        default: "info"
        type: choice
        options:
          - "debug"
          - "info"
          - "warn"
      reset_cache:
        description: "üóëÔ∏è Reset repository cache"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

  # Triggered by eero-api releases
  repository_dispatch:
    types: [eero-api-dependency-update-available]

# Prevent concurrent runs
concurrency:
  group: renovate
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # ============================================================================
  # üîÑ Run Renovate
  # ============================================================================
  renovate:
    name: üîÑ Renovate
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üìã Log trigger info
        run: |
          echo "üéØ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "üì¶ eero-api version: ${{ github.event.client_payload.version }}"
            echo "üîñ eero-api tag: ${{ github.event.client_payload.tag }}"
          fi

      # Wait for PyPI to index the new version when triggered by eero-api release
      # PyPI indexing typically takes 1-5 minutes after package upload
      - name: ‚è≥ Wait for PyPI indexing
        if: github.event_name == 'repository_dispatch'
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          PACKAGE="eero-api"
          MAX_ATTEMPTS=20
          WAIT_SECONDS=15

          echo "üîç Waiting for ${PACKAGE}==${VERSION} to be available on PyPI..."

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "üì° Attempt $i/$MAX_ATTEMPTS: Checking PyPI..."

            # Query PyPI JSON API for the package
            RESPONSE=$(curl -s "https://pypi.org/pypi/${PACKAGE}/json" || echo "error")

            if [ "$RESPONSE" = "error" ]; then
              echo "‚ö†Ô∏è Failed to query PyPI, retrying..."
            else
              # Check if the version exists in the releases
              if echo "$RESPONSE" | jq -e ".releases[\"${VERSION}\"]" > /dev/null 2>&1; then
                echo "‚úÖ ${PACKAGE}==${VERSION} is available on PyPI!"
                exit 0
              else
                echo "‚è≥ Version ${VERSION} not yet available..."
              fi
            fi

            if [ "$i" -lt "$MAX_ATTEMPTS" ]; then
              echo "üí§ Waiting ${WAIT_SECONDS}s before next check..."
              sleep $WAIT_SECONDS
            fi
          done

          echo "‚ö†Ô∏è Timed out waiting for ${PACKAGE}==${VERSION} on PyPI"
          echo "   Proceeding anyway - Renovate will check current PyPI state"

      - name: üîÑ Run Renovate
        uses: fulviofreitas/eero-api/.github/actions/renovate@master
        with:
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          app-private-key: ${{ secrets.RENOVATE_APP_PRIVATE_KEY }}
          config-file: .github/renovate.json5
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}
          log-level: ${{ github.event.inputs.log_level || 'info' }}
          reset-cache: ${{ github.event.inputs.reset_cache || 'false' }}
