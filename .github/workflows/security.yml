# =============================================================================
# ğŸ”’ Security Scanning Workflow
# =============================================================================
# This workflow performs static security analysis on the Python codebase using
# Bandit. Results are uploaded to GitHub Security tab via SARIF format.
#
# Triggers:
#   - Push to master branch
#   - Pull requests targeting master
#   - Manual dispatch
#
# Features:
#   - ğŸ” Bandit static security analysis
#   - ğŸ“Š SARIF report upload to GitHub Security
#   - ğŸ’¬ PR comment with findings summary
#   - âš¡ Fast execution with uv package manager
# =============================================================================

name: ğŸ”’ Security

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

# Ensure only one security scan runs at a time per branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write  # Required for SARIF upload to GitHub Security tab
  pull-requests: write    # Required for PR comments

env:
  PYTHON_VERSION: "3.12"
  UV_CACHE_DIR: /tmp/.uv-cache
  # Bandit configuration
  BANDIT_CONFIDENCE: "MEDIUM"  # Minimum confidence level (LOW, MEDIUM, HIGH)
  BANDIT_SEVERITY: "MEDIUM"    # Minimum severity level (LOW, MEDIUM, HIGH)

jobs:
  # ===========================================================================
  # ğŸ” Bandit Security Scan
  # ===========================================================================
  # Scans Python source code for common security issues including:
  #   - Hardcoded passwords/secrets
  #   - SQL injection vulnerabilities
  #   - Use of insecure functions (eval, exec, etc.)
  #   - Weak cryptography usage
  #   - Shell injection risks
  # ===========================================================================
  bandit:
    name: ğŸ›¡ï¸ Bandit Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # -----------------------------------------------------------------------
      # ğŸ“¥ Checkout Repository
      # -----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # Full history needed for accurate file change detection
          fetch-depth: 0

      # -----------------------------------------------------------------------
      # ğŸ Set up Python Environment
      # -----------------------------------------------------------------------
      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        run: uv python install ${{ env.PYTHON_VERSION }}

      # -----------------------------------------------------------------------
      # ğŸ”§ Install Bandit
      # -----------------------------------------------------------------------
      - name: ğŸ”§ Install Bandit
        run: |
          # Install bandit with SARIF support
          uv tool install bandit[toml,sarif]
          echo "âœ… Bandit installed successfully"
          uvx bandit --version

      # -----------------------------------------------------------------------
      # ğŸ” Run Bandit Security Scan
      # -----------------------------------------------------------------------
      # Scan the entire src/ directory for security vulnerabilities
      # Output formats:
      #   - SARIF: For GitHub Security integration
      #   - Console: For immediate feedback in logs
      # -----------------------------------------------------------------------
      - name: ğŸ” Run Bandit scan
        id: bandit
        run: |
          echo "ğŸ” Starting Bandit security scan..."
          echo "ğŸ“ Scanning: src/"
          echo "ğŸ“Š Minimum confidence: ${{ env.BANDIT_CONFIDENCE }}"
          echo "âš ï¸  Minimum severity: ${{ env.BANDIT_SEVERITY }}"
          echo "-------------------------------------------"
          
          # Run Bandit and capture exit code
          # Exit codes: 0 = no issues, 1 = issues found
          set +e
          
          uvx bandit \
            --recursive \
            --format sarif \
            --output bandit-results.sarif \
            --confidence-level ${{ env.BANDIT_CONFIDENCE }} \
            --severity-level ${{ env.BANDIT_SEVERITY }} \
            --exclude "tests/,**/test_*.py,**/*_test.py" \
            src/
          
          BANDIT_EXIT_CODE=$?
          set -e
          
          # Also generate human-readable output for logs
          echo ""
          echo "ğŸ“‹ Detailed Results:"
          echo "-------------------------------------------"
          uvx bandit \
            --recursive \
            --format txt \
            --confidence-level ${{ env.BANDIT_CONFIDENCE }} \
            --severity-level ${{ env.BANDIT_SEVERITY }} \
            --exclude "tests/,**/test_*.py,**/*_test.py" \
            src/ || true
          
          # Set output for subsequent steps
          echo "exit_code=$BANDIT_EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $BANDIT_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… No security issues found!"
          else
            echo ""
            echo "âš ï¸  Security issues detected (exit code: $BANDIT_EXIT_CODE)"
          fi
        continue-on-error: true  # Allow workflow to continue for SARIF upload

      # -----------------------------------------------------------------------
      # ğŸ“Š Upload SARIF Results to GitHub Security
      # -----------------------------------------------------------------------
      # This integrates findings with GitHub's Security tab, enabling:
      #   - Security alerts visible in repository
      #   - Code scanning alerts on PRs
      #   - Tracking of security issues over time
      # -----------------------------------------------------------------------
      - name: ğŸ“Š Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()  # Upload even if scan found issues
        with:
          sarif_file: bandit-results.sarif
          category: "bandit"
        continue-on-error: true  # Don't fail if SARIF upload has issues

      # -----------------------------------------------------------------------
      # ğŸ“¤ Upload SARIF as Artifact (Backup)
      # -----------------------------------------------------------------------
      # Keep SARIF report as downloadable artifact for debugging
      # -----------------------------------------------------------------------
      - name: ğŸ“¤ Upload SARIF artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-sarif-report
          path: bandit-results.sarif
          retention-days: 30

      # -----------------------------------------------------------------------
      # ğŸ’¬ Comment on PR with Findings Summary
      # -----------------------------------------------------------------------
      # If running on a PR and issues were found, add a helpful comment
      # -----------------------------------------------------------------------
      - name: ğŸ’¬ Comment on PR with findings
        if: github.event_name == 'pull_request' && steps.bandit.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read SARIF results
            let sarifData;
            try {
              sarifData = JSON.parse(fs.readFileSync('bandit-results.sarif', 'utf8'));
            } catch (e) {
              console.log('Could not read SARIF file:', e.message);
              return;
            }
            
            // Extract findings
            const results = sarifData.runs?.[0]?.results || [];
            const totalFindings = results.length;
            
            if (totalFindings === 0) {
              console.log('No findings to report');
              return;
            }
            
            // Count by severity
            const severityCounts = {
              high: 0,
              medium: 0,
              low: 0
            };
            
            results.forEach(result => {
              const level = result.level || 'warning';
              if (level === 'error') severityCounts.high++;
              else if (level === 'warning') severityCounts.medium++;
              else severityCounts.low++;
            });
            
            // Build comment
            const comment = `## ğŸ”’ Security Scan Results
            
            Bandit found **${totalFindings}** potential security issue(s) in this PR.
            
            | Severity | Count |
            |----------|-------|
            | ğŸ”´ High | ${severityCounts.high} |
            | ğŸŸ  Medium | ${severityCounts.medium} |
            | ğŸŸ¡ Low | ${severityCounts.low} |
            
            ### ğŸ“‹ Details
            
            Please review the findings in the **Security** tab or check the workflow logs for details.
            
            > ğŸ’¡ **Tip**: You can view detailed findings by going to **Security** â†’ **Code scanning alerts** in this repository.
            
            ---
            <sub>ğŸ¤– Generated by Bandit Security Scanner</sub>`;
            
            // Find existing comment to update (avoid spam)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ğŸ”’ Security Scan Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing security comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new security comment');
            }

      # -----------------------------------------------------------------------
      # âŒ Fail Workflow if Security Issues Found
      # -----------------------------------------------------------------------
      # This step runs at the end to fail the workflow if Bandit found issues
      # -----------------------------------------------------------------------
      - name: âŒ Check for security failures
        if: steps.bandit.outputs.exit_code != '0'
        run: |
          echo "::error::ğŸ”’ Security scan found vulnerabilities! Please review the findings."
          echo ""
          echo "ğŸ“Œ Next Steps:"
          echo "  1. Check the Security tab in GitHub for detailed findings"
          echo "  2. Review the PR comment for a summary"
          echo "  3. Fix the identified security issues"
          echo "  4. Re-run this workflow"
          echo ""
          exit 1

  # ===========================================================================
  # âœ… Security Check Summary
  # ===========================================================================
  # Final job to provide clear pass/fail status
  # ===========================================================================
  security-check:
    name: âœ… Security Check Complete
    needs: [bandit]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: ğŸ¯ Check security scan status
        run: |
          if [ "${{ needs.bandit.result }}" == "success" ]; then
            echo "âœ… All security checks passed!"
            exit 0
          else
            echo "âŒ Security checks failed!"
            echo "Please review the Bandit scan results and fix any issues."
            exit 1
          fi
