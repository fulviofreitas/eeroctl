name: ğŸ”„ CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write  # Required for SARIF upload
  pull-requests: write    # Required for PR comments

env:
  PYTHON_VERSION: "3.12"
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # ===========================================================================
  # ğŸ§¹ Lint & Format (First Gate - Fast Fail)
  # ===========================================================================
  lint:
    name: ğŸ§¹ Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ğŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ğŸ”§ Install linting tools
        run: uv tool install ruff && uv tool install black && uv tool install isort

      - name: ğŸ–¤ Check formatting with Black
        run: uvx black --check --diff src/ tests/

      - name: ğŸ“‘ Check import sorting with isort
        run: uvx isort --check-only --diff src/ tests/

      - name: âš¡ Lint with Ruff
        run: uvx ruff check src/ tests/

  # ===========================================================================
  # ğŸ” Type Check (Parallel - Informational Only)
  # ===========================================================================
  type-check:
    name: ğŸ” Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint
    # Type checking is informational only until existing type issues are resolved
    continue-on-error: true
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ğŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ğŸ“š Install dependencies
        run: uv sync --extra dev

      - name: ğŸ”¬ Type check with mypy
        run: uv run mypy src/ --ignore-missing-imports || echo "::warning::Type checking found issues (non-blocking)"

  # ===========================================================================
  # ğŸ§ª Test Matrix (After Lint)
  # ===========================================================================
  test:
    name: ğŸ§ª Test (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.12", "3.13", "3.14"]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: ğŸ“š Install dependencies
        run: uv sync --extra dev

      - name: ğŸ–¥ï¸ Run CLI tests
        run: uv run pytest tests/cli/ -v --tb=short

      - name: ğŸ“ˆ Run all tests with coverage
        run: uv run pytest tests/ --cov=src/eero_cli --cov-report=xml --cov-report=term-missing

      - name: ğŸ“Š Upload coverage reports
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ===========================================================================
  # ğŸ”’ Security Scan (After Lint, Parallel with Tests)
  # ===========================================================================
  # Scans Python source code for common security issues including:
  #   - Hardcoded passwords/secrets
  #   - SQL injection vulnerabilities
  #   - Use of insecure functions (eval, exec, etc.)
  #   - Weak cryptography usage
  #   - Shell injection risks
  # ===========================================================================
  security:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    env:
      # Bandit configuration (values must be lowercase: all, low, medium, high)
      BANDIT_CONFIDENCE: "medium"
      BANDIT_SEVERITY: "medium"

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ğŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ğŸ”§ Install Bandit
        run: |
          uv tool install bandit[toml,sarif]
          echo "âœ… Bandit installed successfully"
          uvx bandit --version

      - name: ğŸ” Run Bandit scan
        id: bandit
        run: |
          echo "ğŸ” Starting Bandit security scan..."
          echo "ğŸ“ Scanning: src/"
          echo "ğŸ“Š Minimum confidence: ${{ env.BANDIT_CONFIDENCE }}"
          echo "âš ï¸  Minimum severity: ${{ env.BANDIT_SEVERITY }}"
          echo "-------------------------------------------"
          
          set +e
          
          uvx bandit \
            --recursive \
            --format sarif \
            --output bandit-results.sarif \
            --confidence-level ${{ env.BANDIT_CONFIDENCE }} \
            --severity-level ${{ env.BANDIT_SEVERITY }} \
            --exclude "tests/,**/test_*.py,**/*_test.py" \
            src/
          
          BANDIT_EXIT_CODE=$?
          set -e
          
          # Ensure valid SARIF file exists
          if [ ! -s bandit-results.sarif ]; then
            echo "Creating empty SARIF file (Bandit produced no output)"
            cat > bandit-results.sarif << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "Bandit",
                  "informationUri": "https://bandit.readthedocs.io/",
                  "version": "1.9.2"
                }
              },
              "results": []
            }]
          }
          EOF
          fi
          
          # Generate human-readable output for logs
          echo ""
          echo "ğŸ“‹ Detailed Results:"
          echo "-------------------------------------------"
          uvx bandit \
            --recursive \
            --format txt \
            --confidence-level ${{ env.BANDIT_CONFIDENCE }} \
            --severity-level ${{ env.BANDIT_SEVERITY }} \
            --exclude "tests/,**/test_*.py,**/*_test.py" \
            src/ || true
          
          echo "exit_code=$BANDIT_EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $BANDIT_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… No security issues found!"
          elif [ $BANDIT_EXIT_CODE -eq 1 ]; then
            echo ""
            echo "âš ï¸  Security issues detected!"
          else
            echo ""
            echo "âŒ Bandit encountered an error (exit code: $BANDIT_EXIT_CODE)"
          fi
        continue-on-error: true

      - name: ğŸ“Š Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: "bandit"
        continue-on-error: true

      - name: ğŸ“¤ Upload SARIF artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-sarif-report
          path: bandit-results.sarif
          retention-days: 30

      - name: ğŸ’¬ Comment on PR with findings
        if: github.event_name == 'pull_request' && steps.bandit.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let sarifData;
            try {
              sarifData = JSON.parse(fs.readFileSync('bandit-results.sarif', 'utf8'));
            } catch (e) {
              console.log('Could not read SARIF file:', e.message);
              return;
            }
            
            const results = sarifData.runs?.[0]?.results || [];
            const totalFindings = results.length;
            
            if (totalFindings === 0) {
              console.log('No findings to report');
              return;
            }
            
            const severityCounts = { high: 0, medium: 0, low: 0 };
            
            results.forEach(result => {
              const level = result.level || 'warning';
              if (level === 'error') severityCounts.high++;
              else if (level === 'warning') severityCounts.medium++;
              else severityCounts.low++;
            });
            
            const comment = `## ğŸ”’ Security Scan Results
            
            Bandit found **${totalFindings}** potential security issue(s) in this PR.
            
            | Severity | Count |
            |----------|-------|
            | ğŸ”´ High | ${severityCounts.high} |
            | ğŸŸ  Medium | ${severityCounts.medium} |
            | ğŸŸ¡ Low | ${severityCounts.low} |
            
            ### ğŸ“‹ Details
            
            Please review the findings in the **Security** tab or check the workflow logs for details.
            
            > ğŸ’¡ **Tip**: You can view detailed findings by going to **Security** â†’ **Code scanning alerts** in this repository.
            
            ---
            <sub>ğŸ¤– Generated by Bandit Security Scanner</sub>`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ğŸ”’ Security Scan Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing security comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new security comment');
            }

      - name: âŒ Check for security failures
        if: steps.bandit.outputs.exit_code == '1'
        run: |
          echo "::error::ğŸ”’ Security scan found vulnerabilities! Please review the findings."
          echo ""
          echo "ğŸ“Œ Next Steps:"
          echo "  1. Check the Security tab in GitHub for detailed findings"
          echo "  2. Review the PR comment for a summary"
          echo "  3. Fix the identified security issues"
          echo "  4. Re-run this workflow"
          echo ""
          exit 1

  # ===========================================================================
  # âœ… All Checks Pass (Final Gate)
  # ===========================================================================
  all-checks-pass:
    name: âœ… All Checks Pass
    needs: [lint, type-check, test, security]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - name: ğŸ¯ Check job status
        uses: re-actors/alls-green@release/v1
        with:
          allowed-failures: type-check
          jobs: ${{ toJSON(needs) }}
