# ============================================================================
# ðŸ§ª Continuous Integration Pipeline
# ============================================================================
# Chain: Commit Lint â†’ Lint & Format â†’ [Type Check â€– Security â€– Tests] â†’ CI Success
#
# All reusable actions are sourced from fulviofreitas/eero-client/.github/actions/
# ============================================================================

name: ðŸ§ª CI Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ============================================================================
  # 1ï¸âƒ£ Commit Lint (Gate 1)
  # ============================================================================
  commitlint:
    name: ðŸ“ Commit Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Validate commits
        uses: fulviofreitas/eero-client/.github/actions/commitlint@master
        with:
          from-sha: ${{ github.event.pull_request.base.sha }}
          to-sha: ${{ github.event.pull_request.head.sha }}

  # ============================================================================
  # 2ï¸âƒ£ Lint & Format (Gate 2 - depends on Commit Lint)
  # ============================================================================
  lint:
    name: ðŸ§¹ Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: commitlint

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ðŸ§¹ Run Python lint
        uses: fulviofreitas/eero-client/.github/actions/python-lint@master
        with:
          src-path: "src/"
          tests-path: "tests/"

  # ============================================================================
  # 3ï¸âƒ£ Type Check (Parallel - depends on Lint)
  # ============================================================================
  type-check:
    name: ðŸ” Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint
    continue-on-error: true

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ðŸ“š Install dependencies
        run: uv sync --extra dev

      - name: ðŸ” Run type check
        uses: fulviofreitas/eero-client/.github/actions/python-typecheck@master
        with:
          src-path: "src/"
          fail-on-error: "false"

  # ============================================================================
  # 3ï¸âƒ£ Security Scan (Parallel - depends on Lint)
  # ============================================================================
  security:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: ðŸ›¡ï¸ Run security scan
        uses: fulviofreitas/eero-client/.github/actions/security-bandit@master
        with:
          src-path: "src/"
          fail-on-findings: "false"

  # ============================================================================
  # 3ï¸âƒ£ Test Matrix (Parallel - depends on Lint)
  # ============================================================================
  test:
    name: ðŸ§ª Test (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.12", "3.13", "3.14"]

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: ðŸ“š Install dependencies
        run: uv sync --extra dev

      - name: ðŸ§ª Run tests with coverage
        run: uv run pytest tests/ --cov=src/eero_cli --cov-report=xml --cov-report=term-missing -v

      - name: ðŸ“Š Upload coverage reports
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # 4ï¸âƒ£ CI Success Gate (Final - depends on all parallel jobs)
  # ============================================================================
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [commitlint, lint, type-check, test, security]
    if: always()

    steps:
      - name: ðŸ” Check all jobs passed
        run: |
          COMMITLINT="${{ needs.commitlint.result }}"
          LINT="${{ needs.lint.result }}"
          TYPECHECK="${{ needs.type-check.result }}"
          TEST="${{ needs.test.result }}"
          SECURITY="${{ needs.security.result }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ§ª CI Pipeline Summary

          | Stage | Job | Status |
          |:------|:----|:-------|
          | 1ï¸âƒ£ | ðŸ“ Commit Lint | ${COMMITLINT} |
          | 2ï¸âƒ£ | ðŸ§¹ Lint & Format | ${LINT} |
          | 3ï¸âƒ£ | ðŸ” Type Check | ${TYPECHECK} |
          | 3ï¸âƒ£ | ðŸ›¡ï¸ Security | ${SECURITY} |
          | 3ï¸âƒ£ | ðŸ§ª Tests | ${TEST} |

          EOF

          # Required: commitlint, lint, test
          # Allowed to fail: type-check, security (informational)
          if [[ "$COMMITLINT" == "success" && "$LINT" == "success" && "$TEST" == "success" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          > [!NOTE]
          > ### âœ… All Required Checks Passed
          > CI pipeline completed successfully. Ready for release!

          ---

          ```
          1ï¸âƒ£ ðŸ“ Commit Lint
                 â†“
          2ï¸âƒ£ ðŸ§¹ Lint & Format
                 â†“
               â”Œâ”€â”´â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          3ï¸âƒ£   â”‚   â”‚         â”‚
          ðŸ” Type ðŸ›¡ï¸ Sec  ðŸ§ª Tests
               â””â”€â”¬â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
          4ï¸âƒ£ âœ… CI Success â†’ ðŸš€ Release
          ```

          EOF
            exit 0
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          > [!CAUTION]
          > ### âŒ Some Required Checks Failed
          > Review the failed jobs above and fix any issues before merging.

          EOF
            exit 1
          fi
